define("alinw/upload/2.1.3/upload",["$","arale/base/1.1.1/base","arale/class/1.1.0/class","arale/events/1.1.0/events","./form.handlebars","./blank-iframe.handlebars","./another-iframe.handlebars","./data-input.handlebars","arale/detector/1.3.0/detector"],function(a,b,c){"use strict";var d=a("$"),e=a("arale/base/1.1.1/base"),f=a("./form.handlebars"),g=a("./blank-iframe.handlebars"),h=a("./another-iframe.handlebars"),i=a("./data-input.handlebars");a("arale/detector/1.3.0/detector");var j=0,k=window,l=d("body:first"),m=k.FormData?!0:!1,n=e.extend({attrs:{trigger:null,name:null,action:null,accept:null,multiple:!1,data:{},error:null,success:null,change:null,progress:null,form:null,iframe:null,input:null,files:[],runner:null},initialize:function(a){var b=this;n.superclass.initialize.call(b,a),b.get("trigger")instanceof d||b.set("trigger",d(b.get("trigger"))),b.setup(),b.bindEvents()},getFomStyles:function(){var a=this,b=a.get("trigger");return{top:b.offset().top+"px",left:b.offset().left+"px",width:b.outerWidth()+"px",height:b.outerHeight()+"px",zIndex:a.getZIndex(b)+10}},rePosition:function(){var a=this;a.get("form")&&a.get("form").css(a.getFomStyles())},setup:function(){var a=this,b=a.get("trigger");a.set("iframe",a.newIframe()),a.set("form",d(f({target:a.get("iframe").attr("name"),option:{action:a.get("action"),name:a.get("name"),accept:a.get("accept"),multiple:a.get("multiple")},data:d.map(a.get("data"),function(a,b){return{name:b,value:a}}),isSupportFormData:m,formStyles:a.getFomStyles(),fileInput:{height:b.outerHeight()+"px",fontSize:Math.max(64,5*b.outerHeight())},title:b.attr("title")})).appendTo(l)),a.set("input",a.get("form").find("input[type=file]:last").attr("hidefocus",!0).css({position:"absolute",top:0,right:0,opacity:0,outline:0,cursor:"pointer",height:"100%"})),a.get("input").attr("id","input-"+Math.random()),a._detector=setInterval(function(){a.rePosition()},1e3)},bindEvents:function(){var a=this;a.bindEventsForInput()},bindEventsForInput:function(){var a=this,b=null;m?a.get("input").on("change",function(b){a.set("files",this.files||[{name:b.currentTarget.value}]);var c=b.currentTarget.value;d.isFunction(a.get("change"))?a.get("change").call(a,a.get("files")):c&&a.submit()}):(a.get("input").on("click",function(){b=null,a.clear()}),a.get("runner")&&k.clearInterval(a.get("runner")),a.set("runner",k.setInterval(function(){var c=a.get("input").val();c!==b&&c.length>0&&(a.set("files",this.files||[{name:c}]),d.isFunction(a.get("change"))?a.get("change").call(a,a.get("files")):c&&a.submit()),b=c},300)))},clear:function(){var a=this,b=a.get("input");return b.val(""),b.val()&&(d("<form></form>").append(b)[0].reset(),a.get("form").append(b)),a},submit:function(){var a=this;if(m&&a.get("files")){var b=new k.FormData(a.get("form").get(0));b.append(a.get("name"),a.get("files"));var c=jQuery.ajaxSettings.xhr;if("function"==typeof a.get("progress")){var e=a.get("files");c=function(){var b=d.ajaxSettings.xhr();return b.upload&&b.upload.addEventListener("progress",function(b){var c=0,d=b.loaded||b.position,f=b.total;b.lengthComputable&&(c=Math.ceil(100*(d/f))),a.get("progress")(b,d,f,c,e)},!1),b}}return d.ajax({url:a.get("action"),type:"POST",processData:!1,contentType:!1,data:b,xhr:c,context:this,success:a.get("success"),error:a.get("error"),complete:function(){a.get("input")instanceof d&&a.clear()}}),a}return a.set("iframe",a.newIframe()),a.get("form").attr("target",a.get("iframe").attr("name")),l.append(a.get("iframe")),a.get("iframe").one("load",function(){var b=d(this);d(h({})).appendTo(a.get("form")).remove();var c=b.contents().find("body:first").text();b.remove(),c?d.isFunction(a.get("success"))&&a.get("success")(c):d.isFunction(a.get("error"))&&a.get("error")(a.get("input").val())}),a.get("form").submit(),a},enable:function(){var a=this;a.get("input")instanceof d&&a.get("input").prop("disabled",!1)},disable:function(){var a=this;a.get("input")instanceof d&&a.get("input").prop("disabled",!0)},newIframe:function(){var a=d(g({id:j})).hide();return j+=1,a},getZIndex:function(a){var b=0;return a.parentsUntil("body").each(function(){var a=d(this);"static"!==a.css("position")&&(b=parseInt(a.css("zIndex"),10)||b)}),b},createDataInput:function(a){return i(a)},destroy:function(){var a=this;a._detector&&clearInterval(a._detector),a._detectorFn&&a.observer.disconnect(),a.get("iframe")&&a.get("iframe").remove(),a.get("form")&&a.get("form").remove(),n.superclass.destroy.call(a)}});c.exports=n}),define("alinw/upload/2.1.3/form.handlebars",["gallery/handlebars/1.0.2/runtime"],function(a,b,c){var d=a("gallery/handlebars/1.0.2/runtime"),e=d.template;c.exports=e(function(a,b,c,d,e){function f(a,b){var d,e="";return e+='\n        <input type="hidden" name="',(d=c.name)?d=d.call(a,{hash:{},data:b}):(d=a.name,d=typeof d===q?d.apply(a):d),e+=r(d)+'" value="',(d=c.value)?d=d.call(a,{hash:{},data:b}):(d=a.value,d=typeof d===q?d.apply(a):d),e+=r(d)+'" />\n    '}function g(){return'\n        <input type="hidden" name="_uploader_" value="formdata" />\n    '}function h(){return'\n        <input type="hidden" name="_uploader_" value="iframe" />\n    '}function i(a){var b,c="";return c+='accept="'+r((b=a.option,b=null==b||b===!1?b:b.accept,typeof b===q?b.apply(a):b))+'" '}function j(){return'multiple="multiple"'}function k(a,b){var d;return(d=c.title)?d=d.call(a,{hash:{},data:b}):(d=a.title,d=typeof d===q?d.apply(a):d),r(d)}function l(){return"请选择文件"}this.compilerInfo=[3,">= 1.0.0-rc.4"],c=c||{};for(var m in a.helpers)c[m]=c[m]||a.helpers[m];e=e||{};var n,o,p="",q="function",r=this.escapeExpression,s=this;return p+='\n\n\n\n\n\n<form method="POST" enctype="multipart/form-data" target="',(n=c.target)?n=n.call(b,{hash:{},data:e}):(n=b.target,n=typeof n===q?n.apply(b):n),p+=r(n)+'" action="'+r((n=b.option,n=null==n||n===!1?n:n.action,typeof n===q?n.apply(b):n))+'" style="position:absolute;top: '+r((n=b.formStyles,n=null==n||n===!1?n:n.top,typeof n===q?n.apply(b):n))+";left: "+r((n=b.formStyles,n=null==n||n===!1?n:n.left,typeof n===q?n.apply(b):n))+";overflow: hidden;width: "+r((n=b.formStyles,n=null==n||n===!1?n:n.width,typeof n===q?n.apply(b):n))+"; height: "+r((n=b.formStyles,n=null==n||n===!1?n:n.height,typeof n===q?n.apply(b):n))+";z-index: "+r((n=b.formStyles,n=null==n||n===!1?n:n.zIndex,typeof n===q?n.apply(b):n))+'">\n    ',o=c.each.call(b,b.data,{hash:{},inverse:s.noop,fn:s.program(1,f,e),data:e}),(o||0===o)&&(p+=o),p+="\n    ",o=c["if"].call(b,b.isSupportFormData,{hash:{},inverse:s.program(5,h,e),fn:s.program(3,g,e),data:e}),(o||0===o)&&(p+=o),p+='\n    <input type="file" name="'+r((n=b.option,n=null==n||n===!1?n:n.name,typeof n===q?n.apply(b):n))+'" ',o=c["if"].call(b,(n=b.option,null==n||n===!1?n:n.accept),{hash:{},inverse:s.noop,fn:s.program(7,i,e),data:e}),(o||0===o)&&(p+=o),p+=" ",o=c["if"].call(b,(n=b.option,null==n||n===!1?n:n.multiple),{hash:{},inverse:s.noop,fn:s.program(9,j,e),data:e}),(o||0===o)&&(p+=o),p+=' title="',o=c["if"].call(b,b.title,{hash:{},inverse:s.program(13,l,e),fn:s.program(11,k,e),data:e}),(o||0===o)&&(p+=o),p+='" />\n</form>'})}),define("alinw/upload/2.1.3/blank-iframe.handlebars",["gallery/handlebars/1.0.2/runtime"],function(a,b,c){var d=a("gallery/handlebars/1.0.2/runtime"),e=d.template;c.exports=e(function(a,b,c,d,e){this.compilerInfo=[3,">= 1.0.0-rc.4"],c=c||{};for(var f in a.helpers)c[f]=c[f]||a.helpers[f];e=e||{};var g,h="",i="function",j=this.escapeExpression;return h+='\n\n\n\n\n\n<iframe name="iframe-uploader-',(g=c.id)?g=g.call(b,{hash:{},data:e}):(g=b.id,g=typeof g===i?g.apply(b):g),h+=j(g)+'">\n</iframe>'})}),define("alinw/upload/2.1.3/another-iframe.handlebars",["gallery/handlebars/1.0.2/runtime"],function(a,b,c){var d=a("gallery/handlebars/1.0.2/runtime"),e=d.template;c.exports=e(function(a,b,c,d,e){this.compilerInfo=[3,">= 1.0.0-rc.4"],c=c||{};for(var f in a.helpers)c[f]=c[f]||a.helpers[f];e=e||{};var g="";return g+='\n\n\n\n\n<iframe src="javascript:false;"></iframe>'})}),define("alinw/upload/2.1.3/data-input.handlebars",["gallery/handlebars/1.0.2/runtime"],function(a,b,c){var d=a("gallery/handlebars/1.0.2/runtime"),e=d.template;c.exports=e(function(a,b,c,d,e){function f(a,b){var d;return(d=c.type)?d=d.call(a,{hash:{},data:b}):(d=a.type,d=typeof d===k?d.apply(a):d),l(d)}function g(){return"hidden"}this.compilerInfo=[3,">= 1.0.0-rc.4"],c=c||{};for(var h in a.helpers)c[h]=c[h]||a.helpers[h];e=e||{};var i,j="",k="function",l=this.escapeExpression,m=this;return j+='\n\n\n\n\n\n<input type="',i=c["if"].call(b,b.type,{hash:{},inverse:m.program(3,g,e),fn:m.program(1,f,e),data:e}),(i||0===i)&&(j+=i),j+='" name="',(i=c.name)?i=i.call(b,{hash:{},data:e}):(i=b.name,i=typeof i===k?i.apply(b):i),j+=l(i)+'" value="',(i=c.value)?i=i.call(b,{hash:{},data:e}):(i=b.value,i=typeof i===k?i.apply(b):i),j+=l(i)+'" />'})});
